## 문제

### 1. 배경
> 당신은 대규모 실시간 채팅 애플리케이션 LIME 설계자입니다.
LIME은 데스크톱 앱(Windows/macOS), 모바일 앱(iOS/Android) 을 모두 지원하며, 1:1, 그룹, 공개 채널(오픈채팅) 기능을 제공합니다.
회사는 글로벌 출시를 앞두고 있으며, 성능·안정성·확장성 사이의 어려운 trade-off가 예상되는 요구 사항을 당신에게 전달했습니다.

### 2. 요구 사항
- 실시간성
    - 각 사용자는 자신이 속한 리전 내에서 **100ms 이내에 메시지를 수신해야 한다**.
    - 리전 간 대화의 경우 **200ms 이내에 메시지가 전달되어야 하며**, 네트워크 지연이 있더라도 사용자는 **즉시 반응을 체감해야 한다**.
- 내결함성/내구성
    - 메시지는 모든 복제본(AZ 간 포함)의 디스크 커밋이 완료된 후에만 **전달 확정(ACK)으로 간주한다**.
    - 단일 노드 또는 단일 AZ 장애로 인해 **메시지 유실이 발생해서는 안 된다**.
- 순서/일관성
    - 동일한 방 내의 모든 참여자는 **동일한 순서로 메시지가 보여야 한다**.
- 트래픽 규모
    - DAU 기준 **5천만 명을 예상**한다.
- 확장성
    - 트래픽이 증가해도 **아키텍처 구조 변경 없이 확장 가능해야 한다**.
- 재접속 복구
    - 사용자가 앱/브라우저를 재시작하거나 네트워크가 전환하더라도, 마지막 읽은 메시지 이후의 내역이 **1초 이내로 복원**되어야 한다.

> 회사 경영진은 위의 모든 요구 사항을 서비스 성공을 위한 핵심 목표로 설정하고 있습니다.
당신은 이 요구 사항을 바탕으로,
**서비스의 본질적 가치**를 훼손하지 않으면서 현실적으로 구현 가능한 아키텍처(통신 계층–메시징 계층–저장 계층)를 설계해야 합니다.

## 1. 설계 목표
- 리전 간 네트워크 지연, 장애 등 물리적 한계를 완전히 제거할 수는 없음
- 실시간성, 내결함성, 순서 보장을 동시에 최대로 달성하되, 네트워크 지연 및 장애 상황에서도 사용자가 체감하기에 즉시 응답하는 수준을 목표로 설정

## 2. 컴포넌트 구조
- WebSocket Gateway
  - 실시간 연결 유지 및 메세지 수신/송신 담당 
- Kafka broker
  - 메시지 전달, 비동기 이벤트 파이프라인 역할
  - 리전 내에 3개의 AZ에 분산되어, 각 파티션은 3개의 브로커에 복제되어 저장
- 메세지 API
- 알림 API

### 2-1 토픽 설계
- 메세지 생성 토픽
  - key: vshard(room_id)
- 방 로그 토픽
- 메세지 알림 토픽
- 읽음 상태 변경 토픽

### 2-2. 동작 흐름
1. Websocket 연결
   - 클라이언트가 앱을 실행하면 WebSocket Gateway에 연결 
2. 메시지 전송
   - 클라이언트가 메세지를 전송하면 메시지 API 실행
   - 메시지 API 처리 순서
     1. 검증
     2. 메시지 생성 토픽 발행
        - 발행 성공: 클라이언트에 ACK 반환
        - 발행 실패: 발행 실패 에러 반환
3. 메시지 처리
    1. 수신 워커
       - 메시지 생성 토픽 소비
       - DB에 저장
       - 방 로그 토픽 발행
    2. 팬아웃 워커
       - 방 로그 토픽 소비
       - 방 참여자 조회
         - 온라인: WebSocket 푸시
         - 오프라인
           - 메세지 알림 토픽 발행
           - 알림 API가 소비 후 알림 처리
4. 방 진입
   - Redis 조회
     - 레디스에 1차적으로 읽음 커서 조회
   - DB 조회 
     - 레디스에 없다면 DB를 통해 읽음 커서 조회
   - 읽음 커서를 기반으로 주변 메세지 로딩
   - 읽음 상태 변경 토픽 발행
     - 읽음 워커가 같은 방의 다른 참여자에게 상태 푸시