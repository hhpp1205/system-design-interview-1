
## 1. 요구 사항 정리

| 요구 항목 | 설명                                                     |
|---|--------------------------------------------------------|
| 트래픽 규모 | DAU 1천만                                                |
| 다국어 지원 | 한국어, 영어, 일본어 등           |
| 매칭 방식 | 검색어의 **시작(prefix)** 또는 **중간(infix) 포함** 매칭             |
| 응답 속도 | **≤ 100ms**                                            |
| 추천 개수 | Top 5 자동완성 검색어                                         |
| 인기 반영 | 특정 검색어의 인기가 갑자기 높아지는 경우, 해당 인기도 변화가 실시간 혹은 근접 실시간 반영(**10분 이내** ) |


![검색어_자동완성_시스템.png](img%2F%B0%CB%BB%F6%BE%EE_%C0%DA%B5%BF%BF%CF%BC%BA_%BD%C3%BD%BA%C5%DB.png)

## 데이터 흐름 요약

1. 사용자가 검색어 입력을 시작하면 **검색어 자동완성 서버**가 요청을 처리합니다.

2. 서버는 먼저 **RedisSearch (L1 Cache)** 에서 자동완성 후보를 조회합니다.
    - **Cache Hit**: Redis에 해당 검색어 추천 결과가 존재할 경우, 즉시 반환하여 빠른응답을 제공합니다.
    - **Cache Miss**: Redis에 결과가 없을 경우, **Elasticsearch (L2 Storage)** 에서 검색을 수행하고 사용자에게 반환합니다.

3. 사용자가 검색을 수행하거나 자동완성 추천 검색어를 선택하면,
   해당 검색 이벤트가 **Kafka**로 전송됩니다.

4. **Kafka Streams**는 검색 이벤트를 실시간으로 집계하여
   검색어의 **인기도(최근 검색량)** 를 계산합니다.

5. 계산된 인기 정보는 다시 **RedisSearch** 및 **Elasticsearch**에 반영되며,
   이를 통해 인기 검색어 변화가 **실시간으로 자동완성 결과에 반영**됩니다.



### 검색어 자동완성 서버
- **정규화**: 전처리를 통해 검색어를 표준 형태로 변환하여 L1/L2 인덱스 매칭 정확도와 검색 성능을 향상
  - 공백/특수문자 제거
  - 대문자 -> 소문자
  - 전각 -> 반각
- **검색 및 랭킹**: 검색어 입력 시, prefix·infix 후보를 각각 조회하고 검색량·일치 정도·최근 트렌드 요소를 반영하여 Top 5 후보를 최종적으로 선정
  - L1/L2에서 prefix/infix 후보 각 10개 조회
  - 검색량 + prefix 가중치 + 최근성 기반으로 점수 계산
  - 점수 상위 5개를 자동완성 추천 결과로 반환

### RedisSearch(L1)
- **검색**: `ngram` 기반 인덱스로 prefix/infix 매칭을 빠르게 처리
- **인기 검색어 반영**: Kafka Streams에서 집계한 10분 단위 인기/최근성 지표를 기준으로
  RedisSearch 내 검색어 스코어를 갱신 또는 추가 등록하여 최신 트렌드를 반영

### Elasticsearch(L2)
- **검색**: `edge_ngram`(prefix), `ngram(2~3)`(infix)
- **인기 검색어 반영**:Kafka Streams에서 계산된 인기/검색량 결과를 bulk upsert 방식으로 반영

### Kafka Streams
- **윈도 집계**: 사용자 검색 이벤트를 10분 단위 윈도우로 집계하여 검색량, 최근성, 상승 트렌드 등을 계산
- **랭킹 반영**: 계산된 인기 지표를 RedisSearch(L1) 및 Elasticsearch(L2) 에 업데이트하여 자동완성 추천이 실시간에 가깝게 변화하도록 유지